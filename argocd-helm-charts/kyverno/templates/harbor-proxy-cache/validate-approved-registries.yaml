{{- if (.Values.harborProxyCache).enabled }}
{{- if (.Values.harborProxyCache.validateApprovedRegistries).enabled }}
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: validate-approved-registries
  annotations:
    policies.kyverno.io/title: "Validate only approved container image registries"
    policies.kyverno.io/category: "Image Registry"
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: "Pod,Deployment,StatefulSet,DaemonSet,Job,CronJob"
    policies.kyverno.io/description: >-
      Validates that container images only come from approved registries:
      - Harbor proxy cache ({{ .Values.harborProxyCache.registry }})
      - Azure Container Registry (acrkilroy.azurecr.io)
      - Other approved registries
      Blocks direct Docker Hub pulls to enforce proxy cache usage.
    kyverno.io/kubernetes-version: "1.27+"
    policies.kyverno.io/minversion: "1.11.0"
spec:
  background: false
  validationFailureAction: {{ .Values.harborProxyCache.validateApprovedRegistries.action | default "audit" }}
  rules:
    - name: validate-registry
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
                - Job
                - CronJob
              operations:
                - CREATE
                - UPDATE
      validate:
        message: "Container images must come from approved registries. Direct Docker Hub (docker.io) pulls are blocked. Use Harbor proxy cache instead: {{ .Values.harborProxyCache.registry }}/{{ .Values.harborProxyCache.project }}/<image>"
        foreach:
          # Validate init containers
          - list: "request.object.spec.initContainers[]"
            context:
              - name: imageData
                imageRegistry:
                  reference: "{{`{{ element.image }}`}}"
            deny:
              conditions:
                any:
                  - key: "{{`{{ imageData.registry }}`}}"
                    operator: AnyNotIn
                    value:
                      - {{ .Values.harborProxyCache.registry | quote }}
                      {{- range .Values.harborProxyCache.validateApprovedRegistries.approvedRegistries }}
                      - {{ . | quote }}
                      {{- end }}
          # Validate regular containers
          - list: "request.object.spec.containers[]"
            context:
              - name: imageData
                imageRegistry:
                  reference: "{{`{{ element.image }}`}}"
            deny:
              conditions:
                any:
                  - key: "{{`{{ imageData.registry }}`}}"
                    operator: AnyNotIn
                    value:
                      - {{ .Values.harborProxyCache.registry | quote }}
                      {{- range .Values.harborProxyCache.validateApprovedRegistries.approvedRegistries }}
                      - {{ . | quote }}
                      {{- end }}
          # Validate Deployment template containers
          - list: "request.object.spec.template.spec.containers[]"
            context:
              - name: imageData
                imageRegistry:
                  reference: "{{`{{ element.image }}`}}"
            deny:
              conditions:
                any:
                  - key: "{{`{{ imageData.registry }}`}}"
                    operator: AnyNotIn
                    value:
                      - {{ .Values.harborProxyCache.registry | quote }}
                      {{- range .Values.harborProxyCache.validateApprovedRegistries.approvedRegistries }}
                      - {{ . | quote }}
                      {{- end }}
          # Validate Deployment template init containers
          - list: "request.object.spec.template.spec.initContainers[]"
            context:
              - name: imageData
                imageRegistry:
                  reference: "{{`{{ element.image }}`}}"
            deny:
              conditions:
                any:
                  - key: "{{`{{ imageData.registry }}`}}"
                    operator: AnyNotIn
                    value:
                      - {{ .Values.harborProxyCache.registry | quote }}
                      {{- range .Values.harborProxyCache.validateApprovedRegistries.approvedRegistries }}
                      - {{ . | quote }}
                      {{- end }}
          # Validate CronJob jobTemplate containers
          - list: "request.object.spec.jobTemplate.spec.template.spec.containers[]"
            context:
              - name: imageData
                imageRegistry:
                  reference: "{{`{{ element.image }}`}}"
            deny:
              conditions:
                any:
                  - key: "{{`{{ imageData.registry }}`}}"
                    operator: AnyNotIn
                    value:
                      - {{ .Values.harborProxyCache.registry | quote }}
                      {{- range .Values.harborProxyCache.validateApprovedRegistries.approvedRegistries }}
                      - {{ . | quote }}
                      {{- end }}
          # Validate CronJob jobTemplate init containers
          - list: "request.object.spec.jobTemplate.spec.template.spec.initContainers[]"
            context:
              - name: imageData
                imageRegistry:
                  reference: "{{`{{ element.image }}`}}"
            deny:
              conditions:
                any:
                  - key: "{{`{{ imageData.registry }}`}}"
                    operator: AnyNotIn
                    value:
                      - {{ .Values.harborProxyCache.registry | quote }}
                      {{- range .Values.harborProxyCache.validateApprovedRegistries.approvedRegistries }}
                      - {{ . | quote }}
                      {{- end }}
{{- end }}
{{- end }}

